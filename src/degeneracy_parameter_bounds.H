#ifndef DEGENERACY_PARAMETER_BOUNDS_H
#define DEGENERACY_PARAMETER_BOUNDS_H

#include <algorithm>
#include <array>

#include "real_type.H"
#include "util.H"

using namespace literals;

namespace bounds {

    const std::array<real_t, 19> Ts{
        {1.e3_rt, 3.e3_rt, 1.e4_rt, 3.e4_rt, 1.e5_rt, 3.e5_rt, 1.e6_rt, 3.e6_rt, 1.e7_rt, 3.e7_rt,
         1.e8_rt, 3.e8_rt, 1.e9_rt, 3.e9_rt, 1.e10_rt, 3.e10_rt, 1.e11_rt, 3.e11_rt, 1.e12_rt}};

    const std::array<real_t, 25> rhoYes{
        {1.e-12_rt, 1.e-11_rt, 1.e-10_rt, 1.e-09_rt, 1.e-08_rt, 1.e-07_rt,
         1.e-06_rt, 1.e-05_rt, 1.e-04_rt, 1.e-03_rt, 1.e-02_rt, 1.e-01_rt,
         1.e+00_rt, 1.e+01_rt, 1.e+02_rt, 1.e+03_rt, 1.e+04_rt, 1.e+05_rt,
         1.e+06_rt, 1.e+07_rt, 1.e+08_rt, 1.e+09_rt, 1.e+10_rt, 1.e+11_rt,
         1.e+12_rt}};

    // degeneracy parameters for electrons + positrons

    const std::array<std::array<real_t, 19>, 25> eta_pos{
        {{  -19.351246,   -20.999165,   -22.805127,   -24.453051,   -26.259033,   -27.907014,   -29.713195,   -31.361745,   -33.169916,   -34.824137,   -36.651988,   -19.766322,   -5.9298966,   -1.9766322,  -0.59298966,  -0.19766322, -0.059298966, -0.019766322, -0.0059298966},
         {  -17.048661,    -18.69658,   -20.502541,   -22.150466,   -23.956448,   -25.604429,    -27.41061,    -29.05916,    -30.86733,   -32.521551,   -34.349403,   -19.766322,   -5.9298966,   -1.9766322,  -0.59298966,  -0.19766322, -0.059298966, -0.019766322, -0.0059298966},
         {  -14.746076,   -16.393995,   -18.199956,   -19.847881,   -21.653862,   -23.301844,   -25.108025,   -26.756575,   -28.564745,   -30.218966,   -32.046818,   -19.766322,   -5.9298966,   -1.9766322,  -0.59298966,  -0.19766322, -0.059298966, -0.019766322, -0.0059298966},
         {  -12.443489,    -14.09141,   -15.897371,   -17.545296,   -19.351277,   -20.999259,    -22.80544,    -24.45399,    -26.26216,   -27.916381,   -29.744233,   -19.766318,   -5.9298966,   -1.9766322,  -0.59298966,  -0.19766322, -0.059298966, -0.019766322, -0.0059298966},
         {  -10.140892,   -11.788822,   -13.594786,   -15.242711,   -17.048692,   -18.696674,   -20.502854,   -22.151405,   -23.959575,   -25.613796,   -27.441648,    -19.76628,   -5.9298966,   -1.9766322,  -0.59298966,  -0.19766322, -0.059298966, -0.019766322, -0.0059298966},
         {  -7.8381811,   -9.4862128,   -11.292197,   -12.940125,   -14.746107,   -16.394089,   -18.200269,    -19.84882,    -21.65699,   -23.311211,   -25.139063,   -19.765902,   -5.9298966,   -1.9766322,  -0.59298966,  -0.19766322, -0.059298966, -0.019766322, -0.0059298966},
         {  -5.5343414,   -7.1833862,   -8.9895719,   -10.637532,   -12.443521,   -14.091503,   -15.897684,   -17.546235,   -19.354405,   -21.008626,   -22.836478,   -19.762121,   -5.9298966,   -1.9766322,  -0.59298966,  -0.19766322, -0.059298966, -0.019766322, -0.0059298966},
         {  -3.2192164,   -4.8783866,     -6.68659,   -8.3348708,   -10.140923,   -11.788916,   -13.595099,    -15.24365,    -17.05182,   -18.706041,   -20.533893,   -19.724322,   -5.9298966,   -1.9766322,  -0.59298966,  -0.19766322, -0.059298966, -0.019766322, -0.0059298966},
         { -0.79190906,    -2.551682,   -4.3800378,   -6.0315221,   -7.8382124,   -9.4863067,    -11.29251,   -12.941064,   -14.749235,   -16.403456,   -18.231308,   -19.357667,   -5.9298965,   -1.9766322,  -0.59298966,  -0.19766322, -0.059298966, -0.019766322, -0.0059298966},
         {   2.6973383, -0.010378899,     -2.03785,   -3.7213037,   -5.5343727,   -7.1834802,   -8.9898849,   -10.638471,   -12.446648,    -14.10087,   -15.928723,   -17.623921,    -5.929896,   -1.9766322,  -0.59298966,  -0.19766322, -0.059298966, -0.019766322, -0.0059298966},
         {   13.947355,    4.4772001,   0.65417751,   -1.3426381,   -3.2192483,   -4.8784809,   -6.6869032,   -8.3358097,   -10.144051,   -11.798283,   -13.626137,   -15.335066,    -5.929891,   -1.9766322,  -0.59298966,  -0.19766322, -0.059298966, -0.019766322, -0.0059298966},
         {   64.999655,    21.632695,    6.3692128,    1.6972389,  -0.79194714,   -2.5517797,   -4.3803529,   -6.0324621,   -7.8413408,   -9.4956741,   -11.323548,    -13.03262,   -5.9298411,   -1.9766321,  -0.59298966,  -0.19766322, -0.059298966, -0.019766322, -0.0059298966},
         {   301.75167,    100.57662,    30.148135,    9.9753849,    2.6972213,  -0.01051317,    -2.038184,   -3.7222546,   -5.5375069,   -7.1928509,   -9.0209253,    -10.73003,   -5.9293415,   -1.9766308,  -0.59298964,  -0.19766322, -0.059298966, -0.019766322, -0.0059298966},
         {   1400.4895,    466.82826,    140.04313,    46.665362,    13.945676,    4.4765297,   0.65363494,    -1.343699,   -3.2224415,   -4.8878854,   -6.7179616,   -8.4273784,   -5.9243462,   -1.9766185,  -0.59298943,  -0.19766321, -0.059298966, -0.019766322, -0.0059298966},
         {   6497.7066,    2165.9019,    649.76941,    216.58642,    64.964371,    21.620823,     6.365274,    1.6948675,  -0.79575048,   -2.5615234,   -4.4115916,   -6.1241283,    -5.874421,   -1.9764949,  -0.59298737,  -0.19766314, -0.059298964, -0.019766322, -0.0059298966},
         {   30099.814,    10033.271,    3009.9812,    1003.3263,    300.99538,    100.32441,      30.0721,    9.9489429,    2.6855734, -0.023869169,   -2.0712453,   -3.8148972,   -5.3998921,   -1.9752593,  -0.59296679,  -0.19766241, -0.059298944, -0.019766321, -0.0059298966},
         {   138449.31,     46149.77,    13844.931,    4614.9768,    1384.4925,    461.49582,    138.44303,    46.130917,    13.781662,    4.4109767,   0.60059549,   -1.4462689,   -3.5074264,   -1.9629035,  -0.59276095,  -0.19765514, -0.059298749, -0.019766314, -0.0059298964},
         {   617930.64,    205976.88,    61793.064,    20597.688,    6179.3062,    2059.7683,    617.92899,    205.97194,    61.776578,    20.548117,    6.0087194,    1.4793569,   -1.1327304,   -1.8396945,   -0.5907026,   -0.1975824, -0.059296795, -0.019766242, -0.0059298944},
         {   2493406.3,    831135.42,    249340.63,    83113.542,    24934.063,     8311.354,    2493.4057,    831.13367,     249.3348,    83.096067,    24.875767,    8.1350456,    1.8688757,  -0.82090645,   -0.5701203,  -0.19685501, -0.059277262, -0.019765518, -0.0059298749},
         {   8257369.3,    2752456.4,    825736.93,    275245.64,    82573.693,    27524.564,     8257.369,    2752.4557,    825.73436,    275.23795,    82.548049,    27.447616,    8.0001961,    1.9744244,    -0.365536,  -0.18958116, -0.059081923, -0.019758287, -0.0059296797},
         {    22463773,    7487924.2,    2246377.3,    748792.42,    224637.73,    74879.242,    22463.773,    7487.9239,    2246.3761,    748.78887,    224.62588,     74.84369,    22.345253,    7.1322171,    1.1397213,  -0.11689579, -0.057128541, -0.019685974, -0.0059277273},
         {    54186652,     18062217,    5418665.2,    1806221.7,    541866.52,    180622.17,    54186.652,    18062.217,    5418.6646,    1806.2201,    541.86102,    180.60567,    54.131658,    17.897233,    4.8701345,   0.56528514, -0.037595743, -0.018962842, -0.0059082038},
         {1.2309199e+08,     41030664,     12309199,    4103066.4,    1230919.9,    410306.64,    123091.99,    41030.664,    12309.199,    4103.0656,    1230.9174,    410.29898,    123.06647,    40.954087,    12.053973,    3.3466058,   0.15672171, -0.011731577, -0.0057129688},
         {2.7180891e+08,     90602968,     27180891,    9060296.8,    2718089.1,    906029.68,    271808.91,    90602.968,     27180.89,    9060.2965,    2718.0879,    906.02613,    271.79706,    90.567425,    27.062412,    8.7050383,    1.6259355,  0.060529195, -0.0037606196},
         {5.923332e+08, 1.974444e+08,     59233320,     19744440,      5923332,      1974444,     592333.2,     197444.4,     59233.32,     19744.44,    5923.3315,    1974.4424,     592.3277,     197.4279,    59.178327,    19.579465,    5.3750886,   0.73938248,   0.01576185}}
    };

    template <typename T>
    inline auto get_eta_bounds(T rhoYe0, T temp0) -> std::pair<T, T>
    {

        // find the index into the table such that
        //   rhoYes[ir] <= rhoYe0 < rhoYe[ir+1]
        // and likewise for T

        const auto *const ip = std::upper_bound(rhoYes.cbegin(), rhoYes.cend(), rhoYe0);
        int ir{-1};
        if (ip != rhoYes.cend()) {
            ir = std::clamp(static_cast<int>(std::distance(rhoYes.cbegin(), ip)) - 1,
                              1, static_cast<int>(rhoYes.size())-3);
        }

        const auto *const ip2 = std::upper_bound(Ts.cbegin(), Ts.cend(), temp0);
        int it{-1};
        if (ip2 != Ts.cend()) {
            it = std::clamp(static_cast<int>(std::distance(Ts.cbegin(), ip2)) - 1,
                               1, static_cast<int>(Ts.size())-3);
        }

        if (it < 0 || ir < 0) {
            util::println("thermodynamic state (T = {}, rhoYe = {}) out of bounds", temp0, rhoYe0);
            abort();
        }

        T eta_min{};
        T eta_max{};

        eta_min = std::min(
            {eta_pos[ir-1][it], eta_pos[ir-1][it+1],
             eta_pos[ir][it],   eta_pos[ir][it+1],
             eta_pos[ir+1][it], eta_pos[ir+1][it+1],
             eta_pos[ir+2][it], eta_pos[ir+2][it+1]});
        eta_max = std::max(
            {eta_pos[ir-1][it], eta_pos[ir-1][it+1],
             eta_pos[ir][it],   eta_pos[ir][it+1],
             eta_pos[ir+1][it], eta_pos[ir+1][it+1],
             eta_pos[ir+2][it], eta_pos[ir+2][it+1]});

        return {eta_min, eta_max};
    }

}

#endif
