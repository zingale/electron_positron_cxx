#ifndef DEGENERACY_PARAMETER_BOUNDS_H
#define DEGENERACY_PARAMETER_BOUNDS_H

#include <algorithm>
#include <array>

#include "real_type.H"
#include "util.H"

using namespace literals;

namespace bounds {

    const std::array<real_t, 19> Ts{
        {1.e3_rt, 3.e3_rt, 1.e4_rt, 3.e4_rt, 1.e5_rt, 3.e5_rt, 1.e6_rt, 3.e6_rt, 1.e7_rt, 3.e7_rt,
         1.e8_rt, 3.e8_rt, 1.e9_rt, 3.e9_rt, 1.e10_rt, 3.e10_rt, 1.e11_rt, 3.e11_rt, 1.e12_rt}};

    const std::array<real_t, 49> rhoYes{
        {1.e-12_rt, 3.e-12_rt, 1.e-11_rt, 3.e-11_rt, 1.e-10_rt, 3.e-10_rt,
         1.e-9_rt,  3.e-9_rt,  1.e-8_rt,  3.e-8_rt,  1.e-7_rt,  3.e-7_rt,
         1.e-6_rt,  3.e-6_rt,  1.e-5_rt,  3.e-5_rt,  1.e-4_rt,  3.e-4_rt,
         1.e-3_rt,  3.e-3_rt,  1.e-2_rt,  3.e-2_rt,  1.e-1_rt,  3.e-1_rt,
         1.e0_rt,   3.e0_rt,   1.e1_rt,   3.e1_rt,   1.e2_rt,   3.e2_rt,
         1.e3_rt,   3.e3_rt,   1.e4_rt,   3.e4_rt,   1.e5_rt,   3.e5_rt,
         1.e6_rt,   3.e6_rt,   1.e7_rt,   3.e7_rt,   1.e8_rt,   3.e8_rt,
         1.e9_rt,   3.e9_rt,   1.e10_rt,  3.e10_rt,  1.e11_rt,  3.e11_rt,
         1.e12_rt}};


    // degeneracy parameters for electrons + positrons

    const std::array<std::array<real_t, 19>, 49> eta_pos{
        {{  -19.351246,   -20.999165,   -22.805127,   -24.453051,   -26.259033,   -27.907014,   -29.713195,   -31.361745,   -33.169916,   -34.824137,   -36.651988,   -19.766322,   -5.9298966,   -1.9766322,  -0.59298966,  -0.19766322, -0.059298966, -0.019766322, -0.0059298966},
         {  -18.252634,   -19.900553,   -21.706514,   -23.354439,    -25.16042,   -26.808402,   -28.614582,   -30.263133,   -32.071303,   -33.725524,   -35.553376,   -19.766322,   -5.9298966,   -1.9766322,  -0.59298966,  -0.19766322, -0.059298966, -0.019766322, -0.0059298966},
         {  -17.048661,    -18.69658,   -20.502541,   -22.150466,   -23.956448,   -25.604429,    -27.41061,    -29.05916,    -30.86733,   -32.521551,   -34.349403,   -19.766322,   -5.9298966,   -1.9766322,  -0.59298966,  -0.19766322, -0.059298966, -0.019766322, -0.0059298966},
         {  -15.950049,   -17.597968,   -19.403929,   -21.051854,   -22.857835,   -24.505817,   -26.311997,   -27.960548,   -29.768718,   -31.422939,   -33.250791,   -19.766322,   -5.9298966,   -1.9766322,  -0.59298966,  -0.19766322, -0.059298966, -0.019766322, -0.0059298966},
         {  -14.746076,   -16.393995,   -18.199956,   -19.847881,   -21.653862,   -23.301844,   -25.108025,   -26.756575,   -28.564745,   -30.218966,   -32.046818,   -19.766322,   -5.9298966,   -1.9766322,  -0.59298966,  -0.19766322, -0.059298966, -0.019766322, -0.0059298966},
         {  -13.647463,   -15.295383,   -17.101344,   -18.749269,    -20.55525,   -22.203232,   -24.009412,   -25.657963,   -27.466133,   -29.120354,   -30.948206,   -19.766321,   -5.9298966,   -1.9766322,  -0.59298966,  -0.19766322, -0.059298966, -0.019766322, -0.0059298966},
         {  -12.443489,    -14.09141,   -15.897371,   -17.545296,   -19.351277,   -20.999259,    -22.80544,    -24.45399,    -26.26216,   -27.916381,   -29.744233,   -19.766318,   -5.9298966,   -1.9766322,  -0.59298966,  -0.19766322, -0.059298966, -0.019766322, -0.0059298966},
         {  -11.344874,   -12.992797,   -14.798759,   -16.446684,   -18.252665,   -19.900647,   -21.706827,   -23.355378,   -25.163548,   -26.817769,   -28.645621,   -19.766309,   -5.9298966,   -1.9766322,  -0.59298966,  -0.19766322, -0.059298966, -0.019766322, -0.0059298966},
         {  -10.140892,   -11.788822,   -13.594786,   -15.242711,   -17.048692,   -18.696674,   -20.502854,   -22.151405,   -23.959575,   -25.613796,   -27.441648,    -19.76628,   -5.9298966,   -1.9766322,  -0.59298966,  -0.19766322, -0.059298966, -0.019766322, -0.0059298966},
         {  -9.0422515,   -10.690204,   -12.496173,   -14.144098,    -15.95008,   -17.598062,   -19.404242,   -21.052793,   -22.860963,   -24.515184,   -26.343036,   -19.766196,   -5.9298966,   -1.9766322,  -0.59298966,  -0.19766322, -0.059298966, -0.019766322, -0.0059298966},
         {  -7.8381811,   -9.4862128,   -11.292197,   -12.940125,   -14.746107,   -16.394089,   -18.200269,    -19.84882,    -21.65699,   -23.311211,   -25.139063,   -19.765902,   -5.9298966,   -1.9766322,  -0.59298966,  -0.19766322, -0.059298966, -0.019766322, -0.0059298966},
         {    -6.73929,   -8.3875468,   -10.193576,   -11.841511,   -13.647494,   -15.295476,   -17.101657,   -18.750208,   -20.558378,   -22.212599,   -24.040451,   -19.765062,   -5.9298966,   -1.9766322,  -0.59298966,  -0.19766322, -0.059298966, -0.019766322, -0.0059298966},
         {  -5.5343414,   -7.1833862,   -8.9895719,   -10.637532,   -12.443521,   -14.091503,   -15.897684,   -17.546235,   -19.354405,   -21.008626,   -22.836478,   -19.762121,   -5.9298966,   -1.9766322,  -0.59298966,  -0.19766322, -0.059298966, -0.019766322, -0.0059298966},
         {  -4.4329414,   -6.0842373,   -7.8908714,    -9.538903,   -11.344906,   -12.992891,   -14.799072,   -16.447623,   -18.255793,   -19.910014,   -21.737866,   -19.753719,   -5.9298966,   -1.9766322,  -0.59298966,  -0.19766322, -0.059298966, -0.019766322, -0.0059298966},
         {  -3.2192164,   -4.8783866,     -6.68659,   -8.3348708,   -10.140923,   -11.788916,   -13.595099,    -15.24365,    -17.05182,   -18.706041,   -20.533893,   -19.724322,   -5.9298966,   -1.9766322,  -0.59298966,  -0.19766322, -0.059298966, -0.019766322, -0.0059298966},
         {   -2.092782,   -3.7744105,    -5.587096,   -7.2360888,   -9.0422828,   -10.690298,   -12.496486,   -14.145037,   -15.953208,   -17.607429,    -19.43528,   -19.640616,   -5.9298966,   -1.9766322,  -0.59298966,  -0.19766322, -0.059298966, -0.019766322, -0.0059298966},
         { -0.79190906,    -2.551682,   -4.3800378,   -6.0315221,   -7.8382124,   -9.4863067,    -11.29251,   -12.941064,   -14.749235,   -16.403456,   -18.231308,   -19.357667,   -5.9298965,   -1.9766322,  -0.59298966,  -0.19766322, -0.059298966, -0.019766322, -0.0059298966},
         {  0.57960756,   -1.3996346,   -3.2726142,   -4.9312131,   -6.7393213,   -8.3876408,   -10.193889,    -11.84245,   -13.650622,   -15.304843,   -17.132695,   -18.712264,   -5.9298964,   -1.9766322,  -0.59298966,  -0.19766322, -0.059298966, -0.019766322, -0.0059298966},
         {   2.6973383, -0.010378899,     -2.03785,   -3.7213037,   -5.5343727,   -7.1834802,   -8.9898849,   -10.638471,   -12.446648,    -14.10087,   -15.928723,   -17.623921,    -5.929896,   -1.9766322,  -0.59298966,  -0.19766322, -0.059298966, -0.019766322, -0.0059298966},
         {   6.1396975,    1.6036169,   -0.8516715,   -2.6057452,   -4.4329729,   -6.0843314,   -7.8911845,   -9.5398419,   -11.348033,   -13.002258,    -14.83011,    -16.53761,   -5.9298949,   -1.9766322,  -0.59298966,  -0.19766322, -0.059298966, -0.019766322, -0.0059298966},
         {   13.947355,    4.4772001,   0.65417751,   -1.3426381,   -3.2192483,   -4.8784809,   -6.6869032,   -8.3358097,   -10.144051,   -11.798283,   -13.626137,   -15.335066,    -5.929891,   -1.9766322,  -0.59298966,  -0.19766322, -0.059298966, -0.019766322, -0.0059298966},
         {   29.106456,    9.6254143,    2.5796528, -0.076563958,   -2.0928153,   -3.7745055,   -5.5874096,    -7.237028,   -9.0454107,   -10.699665,   -12.527524,   -14.236579,   -5.9298799,   -1.9766322,  -0.59298966,  -0.19766322, -0.059298966, -0.019766322, -0.0059298966},
         {   64.999655,    21.632695,    6.3692128,    1.6972389,  -0.79194714,   -2.5517797,   -4.3803529,   -6.0324621,   -7.8413408,   -9.4956741,   -11.323548,    -13.03262,   -5.9298411,   -1.9766321,  -0.59298966,  -0.19766322, -0.059298966, -0.019766322, -0.0059298966},
         {   135.22417,    45.058491,    13.461686,    4.3080585,   0.57955457,     -1.39974,   -3.2729334,   -4.9321556,    -6.742451,   -8.3970089,   -10.224928,   -11.934008,   -5.9297301,   -1.9766318,  -0.59298965,  -0.19766322, -0.059298966, -0.019766322, -0.0059298966},
         {   301.75167,    100.57662,    30.148135,    9.9753849,    2.6972213,  -0.01051317,    -2.038184,   -3.7222546,   -5.5375069,   -7.1928509,   -9.0209253,    -10.73003,   -5.9293415,   -1.9766308,  -0.59298964,  -0.19766322, -0.059298966, -0.019766322, -0.0059298966},
         {   627.65587,    209.21513,    62.752606,    20.882449,    6.1393271,     1.603388,  -0.85204871,   -2.6067201,   -4.4361201,   -6.0937096,   -7.9222288,    -9.631403,   -5.9282315,   -1.9766281,  -0.59298959,  -0.19766322, -0.059298966, -0.019766322, -0.0059298966},
         {   1400.4895,    466.82826,    140.04313,    46.665362,    13.945676,    4.4765297,   0.65363494,    -1.343699,   -3.2224415,   -4.8878854,   -6.7179616,   -8.4273784,   -5.9243462,   -1.9766185,  -0.59298943,  -0.19766321, -0.059298966, -0.019766322, -0.0059298966},
         {   2912.7651,    970.92094,    291.27371,    97.083696,    29.099333,    9.6229297,    2.5785353, -0.077884119,   -2.0961408,    -3.783985,   -5.6185081,   -7.3286184,   -5.9132462,    -1.976591,  -0.59298897,   -0.1976632, -0.059298965, -0.019766322, -0.0059298966},
         {   6497.7066,    2165.9019,    649.76941,    216.58642,    64.964371,    21.620823,     6.365274,    1.6948675,  -0.79575048,   -2.5615234,   -4.4115916,   -6.1241283,    -5.874421,   -1.9764949,  -0.59298737,  -0.19766314, -0.059298964, -0.019766322, -0.0059298966},
         {   13507.795,    4502.5981,    1350.7789,    450.25799,    135.07183,    45.007599,    13.446044,     4.301737,   0.57426788,   -1.4102524,   -3.3045743,   -5.0240385,   -5.7641412,   -1.9762203,   -0.5929828,  -0.19766298, -0.059298959, -0.019766322, -0.0059298966},
         {   30099.814,    10033.271,    3009.9812,    1003.3263,    300.99538,    100.32441,      30.0721,    9.9489429,    2.6855734, -0.023869169,   -2.0712453,   -3.8148972,   -5.3998921,   -1.9752593,  -0.59296679,  -0.19766241, -0.059298944, -0.019766321, -0.0059298966},
         {     62440.3,    20813.433,    6244.0298,    2081.3429,    624.40165,    208.13028,    62.426779,    20.772751,    6.1026711,    1.5807212,  -0.88927995,   -2.7015434,   -4.6455821,   -1.9725135,  -0.59292105,  -0.19766079, -0.059298901,  -0.01976632, -0.0059298965},
         {   138449.31,     46149.77,    13844.931,    4614.9768,    1384.4925,    461.49582,    138.44303,    46.130917,    13.781662,    4.4109767,   0.60059549,   -1.4462689,   -3.5074264,   -1.9629035,  -0.59276095,  -0.19765514, -0.059298749, -0.019766314, -0.0059298964},
         {   284522.25,    94840.749,    28452.225,    9484.0748,    2845.2221,    948.40652,    284.51902,    94.831078,    28.419943,    9.3858729,    2.4717107,  -0.20351589,   -2.3979563,   -1.9354546,  -0.59230354,  -0.19763897, -0.059298315, -0.019766298, -0.0059298959},
         {   617930.64,    205976.88,    61793.064,    20597.688,    6179.3062,    2059.7683,    617.92899,    205.97194,    61.776578,    20.548117,    6.0087194,    1.4793569,   -1.1327304,   -1.8396945,   -0.5907026,   -0.1975824, -0.059296795, -0.019766242, -0.0059298944},
         {   1225652.7,    408550.89,    122565.27,    40855.088,    12256.526,    4085.5086,    1225.6517,    408.54799,    122.55563,    40.826161,    12.159588,    3.7785262,   0.13592104,   -1.5737737,   -0.5861285,  -0.19742076, -0.059292455, -0.019766081, -0.0059298901},
         {   2493406.3,    831135.42,    249340.63,    83113.542,    24934.063,     8311.354,    2493.4057,    831.13367,     249.3348,    83.096067,    24.875767,    8.1350456,    1.8688757,  -0.82090645,   -0.5701203,  -0.19685501, -0.059277262, -0.019765518, -0.0059298749},
         {   4539413.6,    1513137.9,    453941.36,    151313.79,    45394.136,    15131.379,    4539.4132,    1513.1367,    453.93748,    151.30213,    45.355284,    15.014666,    4.1434409,   0.32796885,   -0.5244121,  -0.19523859, -0.059233853, -0.019763912, -0.0059298315},
         {   8257369.3,    2752456.4,    825736.93,    275245.64,    82573.693,    27524.564,     8257.369,    2752.4557,    825.73436,    275.23795,    82.548049,    27.447616,    8.0001961,    1.9744244,    -0.365536,  -0.18958116, -0.059081923, -0.019758287, -0.0059296797},
         {    13581548,    4527182.6,    1358154.8,    452718.26,    135815.48,    45271.826,    13581.548,    4527.1821,     1358.153,    452.71295,    135.79776,    45.218666,     13.40426,    3.9939708,  0.063065174,  -0.17341833, -0.058647838, -0.019742218, -0.0059292458},
         {    22463773,    7487924.2,    2246377.3,    748792.42,    224637.73,    74879.242,    22463.773,    7487.9239,    2246.3761,    748.78887,    224.62588,     74.84369,    22.345253,    7.1322171,    1.1397213,  -0.11689579, -0.057128541, -0.019685974, -0.0059277273},
         {    34554481,     11518160,    3455448.1,      1151816,    345544.81,     115181.6,    34554.481,     11518.16,    3455.4473,    1151.8136,    345.53659,    115.15696,    34.472326,    11.271675,    2.6453361,  0.043372915, -0.052787716, -0.019525278, -0.0059233887},
         {    54186652,     18062217,    5418665.2,    1806221.7,    541866.52,    180622.17,    54186.652,    18062.217,    5418.6646,    1806.2201,    541.86102,    180.60567,    54.131658,    17.897233,    4.8701345,   0.56528514, -0.037595743, -0.018962842, -0.0059082038},
         {    80553871,     26851290,    8055387.1,      2685129,    805538.71,     268512.9,    80553.871,     26851.29,    8055.3867,    2685.1279,    805.53489,    268.50146,     80.51574,    26.736899,    7.6743022,    1.6174602, 0.0057858634, -0.017355884, -0.0058648182}, //NOLINT(modernize-use-std-numbers)
         {1.2309199e+08,     41030664,     12309199,    4103066.4,    1230919.9,    410306.64,    123091.99,    41030.664,    12309.199,    4103.0656,    1230.9174,    410.29898,    123.06647,    40.954087,    12.053973,    3.3466058,   0.15672171, -0.011731577, -0.0057129688},
         {1.8004979e+08,     60016596,     18004979,    6001659.6,    1800497.9,    600165.96,    180049.79,    60016.596,    18004.979,     6001.659,    1800.4961,    600.16065,    180.03209,      59.9635,    17.827999,    5.4720916,   0.56693241, 0.0043366511, -0.0052791132},
         {2.7180891e+08,     90602968,     27180891,    9060296.8,    2718089.1,    906029.68,    271808.91,    90602.968,     27180.89,    9060.2965,    2718.0879,    906.02613,    271.79706,    90.567425,    27.062412,    8.7050383,    1.6259355,  0.060529195, -0.0037606196},
         {3.9459136e+08, 1.3153045e+08,     39459136,     13153045,    3945913.6,    1315304.5,    394591.36,    131530.45,    39459.136,    13153.045,    3945.9128,    1315.3021,    394.58315,    131.50581,    39.376988,    12.906627,    3.1381258,   0.21988298, 0.00057790964},
         {5.923332e+08, 1.974444e+08,     59233320,     19744440,      5923332,      1974444,     592333.2,     197444.4,     59233.32,     19744.44,    5923.3315,    1974.4424,     592.3277,     197.4279,    59.178327,    19.579465,    5.3750886,   0.73938248,   0.01576185}}
    };

    template <typename T>
    inline auto get_eta_bounds(T rhoYe0, T temp0) -> std::pair<T, T>
    {

        // find the index into the table such that
        //   rhoYes[ir] <= rhoYe0 < rhoYe[ir+1]
        // and likewise for T

        const auto *const ip = std::upper_bound(rhoYes.cbegin(), rhoYes.cend(), rhoYe0);
        int ir{-1};
        if (ip != rhoYes.cend()) {
            ir = std::clamp(static_cast<int>(std::distance(rhoYes.cbegin(), ip)) - 1,
                              1, static_cast<int>(rhoYes.size())-3);
        }

        const auto *const ip2 = std::upper_bound(Ts.cbegin(), Ts.cend(), temp0);
        int it{-1};
        if (ip2 != Ts.cend()) {
            it = std::clamp(static_cast<int>(std::distance(Ts.cbegin(), ip2)) - 1,
                               1, static_cast<int>(Ts.size())-3);
        }

        if (it < 0 || ir < 0) {
            util::println("thermodynamic state (T = {}, rhoYe = {}) out of bounds", temp0, rhoYe0);
            abort();
        }

        T eta_min{};
        T eta_max{};

        eta_min = std::min(
            {eta_pos[ir-1][it], eta_pos[ir-1][it+1],
             eta_pos[ir][it],   eta_pos[ir][it+1],
             eta_pos[ir+1][it], eta_pos[ir+1][it+1],
             eta_pos[ir+2][it], eta_pos[ir+2][it+1]});
        eta_max = std::max(
            {eta_pos[ir-1][it], eta_pos[ir-1][it+1],
             eta_pos[ir][it],   eta_pos[ir][it+1],
             eta_pos[ir+1][it], eta_pos[ir+1][it+1],
             eta_pos[ir+2][it], eta_pos[ir+2][it+1]});

        return {eta_min, eta_max};
    }

}

#endif
